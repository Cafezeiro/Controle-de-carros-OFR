<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cadastro ‚Äì √Årea de Carregamento</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

<style>
body{
  font-family:Inter,Segoe UI,Arial;
  background:#f5f7fb;
  margin:0;
  padding:14px
}
.wrap{
  max-width:560px;
  margin:auto;
  background:#fff;
  border-radius:14px;
  padding:16px;
  box-shadow:0 6px 20px rgba(0,0,0,.08)
}
h1{
  margin:0 0 14px;
  color:#2563eb;
  text-align:center;
  font-size:20px
}
.tabs{
  display:flex;
  gap:6px;
  margin-bottom:12px
}
.tab{
  flex:1;
  padding:12px;
  border-radius:10px;
  background:#eef2ff;
  font-weight:800;
  text-align:center;
  cursor:pointer
}
.tab.active{
  background:#2563eb;
  color:#fff
}
label{font-weight:700;font-size:14px}
input{
  width:100%;
  padding:14px;
  margin-top:6px;
  margin-bottom:12px;
  font-size:16px;
  border-radius:8px;
  border:1px solid #d1d5db
}
input[type="text"]{text-transform:uppercase}
.btn{
  width:100%;
  padding:16px;
  font-size:16px;
  font-weight:800;
  border:none;
  border-radius:12px;
  cursor:pointer;
  margin-top:6px
}
.normal{background:#16a34a;color:#fff}
.ofr{background:#dc2626;color:#fff}
.finalizar{background:#ef4444;color:#fff}
.download{background:#0ea5e9;color:#fff}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#f1f5f9}
tr.ofr{background:rgba(239,68,68,.12);font-weight:700}
.hidden{display:none}
</style>
</head>

<body>
<div class="wrap">
<h1>üöõ Controle de Carregamento</h1>

<div class="tabs">
  <div id="tabCadastro" class="tab active">üìã Cadastro</div>
  <div id="tabFila" class="tab">üöõ Retirada</div>
</div>

<!-- CADASTRO -->
<div id="cadastroSection">
  <label>N¬∫ Transporte</label>
  <input id="transporte" type="number" inputmode="numeric">

  <label>Placa</label>
  <input id="placa" type="text">

  <label>Entrada Usina</label>
  <input id="entrada" type="datetime-local">

  <label>Chegada √Årea</label>
  <input id="chegada" type="datetime-local">

  <button class="btn normal" onclick="adicionar(false)">Adicionar Normal</button>
  <button class="btn ofr" onclick="adicionar(true)">Adicionar OFR</button>
</div>

<!-- RETIRADA -->
<div id="filaSection" class="hidden">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Transp.</th>
        <th>Placa</th>
        <th>Tipo</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody id="filaBody"></tbody>
  </table>

  <button class="btn download" onclick="baixarRelatorio()">
    üì• Baixar Relat√≥rio Completo (CSV)
  </button>
</div>
</div>

<script>
// üî• FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyC4QzvRKk-l7F9RbgIt_N7_It3FxZ_TIhM",
  authDomain: "controle-carregamento.firebaseapp.com",
  databaseURL: "https://controle-carregamento-default-rtdb.firebaseio.com",
  projectId: "controle-carregamento",
  storageBucket: "controle-carregamento.firebasestorage.app",
  messagingSenderId: "880348216752",
  appId: "1:880348216752:web:fbea1e525c37c877e22a75"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* helpers */
const diffMin = (a,b)=>{
  const d = new Date(b).getTime() - new Date(a).getTime();
  const m = Math.floor(d/60000);
  const h = Math.floor(m/60);
  return h>0 ? `${h}h ${m%60}m` : `${m}m`;
};

/* tabs */
tabCadastro.onclick = ()=>{
  tabCadastro.classList.add("active");
  tabFila.classList.remove("active");
  cadastroSection.classList.remove("hidden");
  filaSection.classList.add("hidden");
};
tabFila.onclick = ()=>{
  tabFila.classList.add("active");
  tabCadastro.classList.remove("active");
  filaSection.classList.remove("hidden");
  cadastroSection.classList.add("hidden");
};

/* adicionar */
function adicionar(ofr){
  if(!transporte.value||!placa.value||!entrada.value||!chegada.value){
    alert("Preencha todos os campos");
    return;
  }
  const id = Date.now();
  db.ref("fila/"+id).set({
    transporte: transporte.value,
    placa: placa.value.toUpperCase(),
    entrada: entrada.value,
    chegada: chegada.value,
    tipo: ofr?"OFR":"Normal",
    criadoEm: new Date().toISOString()
  });
  transporte.value=placa.value=entrada.value=chegada.value="";
}

/* listar fila */
db.ref("fila").on("value", snap=>{
  const data = snap.val() || {};
  filaBody.innerHTML="";
  Object.entries(data).forEach(([id,v],i)=>{
    const tr=document.createElement("tr");
    if(v.tipo==="OFR") tr.classList.add("ofr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${v.transporte}</td>
      <td>${v.placa}</td>
      <td>${v.tipo}</td>
      <td><button class="btn finalizar" onclick="finalizar('${id}')">Finalizar</button></td>
    `;
    filaBody.appendChild(tr);
  });
});

/* finalizar */
function finalizar(id){
  if(!confirm("Finalizar este ve√≠culo?")) return;
  db.ref("fila/"+id).once("value").then(snap=>{
    const v = snap.val();
    v.saida = new Date().toISOString();
    db.ref("historico/"+id).set(v);
    db.ref("fila/"+id).remove();
  });
}

/* relat√≥rio detalhado */
function baixarRelatorio(){
  db.ref("historico").once("value").then(snap=>{
    const data = snap.val();
    if(!data){ alert("Sem hist√≥rico"); return; }

    const header = [
      "Transporte","Placa",
      "Entrada Usina","Chegada √Årea","Sa√≠da",
      "Tempo Usina","Tempo √Årea","Tipo"
    ];

    const rows = Object.values(data).map(v=>[
      v.transporte,
      v.placa,
      new Date(v.entrada).toLocaleString("pt-BR",{hour12:false}),
      new Date(v.chegada).toLocaleString("pt-BR",{hour12:false}),
      new Date(v.saida).toLocaleString("pt-BR",{hour12:false}),
      diffMin(v.entrada, v.chegada),
      diffMin(v.chegada, v.saida),
      v.tipo
    ]);

    const csv = [header, ...rows]
      .map(r=>r.map(c=>`"${c}"`).join(";"))
      .join("\n");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(
      new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"})
    );
    a.download = "relatorio_carregamento_detalhado.csv";
    a.click();
  });
}
</script>
</body>
</html>
